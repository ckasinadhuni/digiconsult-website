#!/bin/bash

# Claude Session Search - Single command to search all session history
# Usage: claude-search "search term" [options]

ADMIN_DIR="/home/ubuntu/claude-prompts/admin"

# Default options
SEARCH_TYPE="all"
SHOW_CONTEXT=false
LIMIT=10
DATE_FILTER=""
USE_INDEX=false

# Help function
show_help() {
    cat << EOF
Claude Session Search - Search through all session history

Usage: claude-search "search term" [options]

Options:
    -p, --prompts-only     Search only user prompts
    -r, --responses-only   Search only Claude responses  
    -f, --files-only       Search only file modifications
    -c, --context          Show surrounding context (3 lines)
    -l, --limit N          Limit results to N entries (default: 10)
    -d, --date YYYY-MM-DD  Filter by specific date
    -w, --week             Show results from last 7 days
    -m, --month            Show results from last 30 days
    -a, --all              Show all results (no limit)
    -i, --index            Use fast indexed search (builds index if needed)
    -h, --help             Show this help

Examples:
    claude-search "file watcher"
    claude-search "error" --prompts-only --context
    claude-search "python" --limit 5 --week
    claude-search "session" --files-only --date 2025-08-20

Search Targets:
    - User prompts and commands
    - Claude responses and outputs
    - File modifications
    - Session metadata
EOF
}

# Parse arguments
SEARCH_TERM=""
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--prompts-only)
            SEARCH_TYPE="prompts"
            shift
            ;;
        -r|--responses-only)
            SEARCH_TYPE="responses"
            shift
            ;;
        -f|--files-only)
            SEARCH_TYPE="files"
            shift
            ;;
        -c|--context)
            SHOW_CONTEXT=true
            shift
            ;;
        -l|--limit)
            LIMIT="$2"
            shift 2
            ;;
        -d|--date)
            DATE_FILTER="$2"
            shift 2
            ;;
        -w|--week)
            DATE_FILTER=$(date -d "7 days ago" +%Y-%m-%d)
            shift
            ;;
        -m|--month)
            DATE_FILTER=$(date -d "30 days ago" +%Y-%m-%d)
            shift
            ;;
        -a|--all)
            LIMIT=""
            shift
            ;;
        -i|--index)
            USE_INDEX=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            if [[ -z "$SEARCH_TERM" ]]; then
                SEARCH_TERM="$1"
            else
                echo "Error: Unexpected argument: $1"
                exit 1
            fi
            shift
            ;;
    esac
done

# Check if search term provided
if [[ -z "$SEARCH_TERM" ]]; then
    echo "Error: Please provide a search term"
    echo "Use 'claude-search --help' for usage information"
    exit 1
fi

# Find session files
if [[ -n "$DATE_FILTER" ]]; then
    SESSION_FILES=$(find "$ADMIN_DIR" -name "session-$DATE_FILTER*.md" -o -name "session-$(date -d "$DATE_FILTER" +%Y-%m-%d)*.md" 2>/dev/null | sort -r)
else
    SESSION_FILES=$(find "$ADMIN_DIR" -name "session-*.md" 2>/dev/null | sort -r)
fi

if [[ -z "$SESSION_FILES" ]]; then
    echo "No session files found"
    exit 0
fi

# Build grep options
GREP_OPTS="-i"  # Case insensitive
if [[ "$SHOW_CONTEXT" == "true" ]]; then
    GREP_OPTS="$GREP_OPTS -A3 -B3"
fi

# Color options
if [[ -t 1 ]]; then  # If output is to terminal
    GREP_OPTS="$GREP_OPTS --color=always"
fi

# Search function
perform_search() {
    local files="$1"
    local pattern="$2"
    local search_type="$3"
    local count=0
    
    for file in $files; do
        [[ ! -f "$file" ]] && continue
        
        local session_id=$(basename "$file" .md | sed 's/session-//')
        local session_date=$(echo "$session_id" | cut -d'-' -f1-3)
        local session_time=$(echo "$session_id" | cut -d'-' -f4)
        
        # Format time for display
        local formatted_time="${session_time:0:2}:${session_time:2:2}"
        
        echo -e "\n\033[1;34m=== Session: $session_date $formatted_time ===\033[0m"
        
        case "$search_type" in
            "prompts")
                grep $GREP_OPTS -A10 "Command/Request:" "$file" | grep $GREP_OPTS "$pattern"
                ;;
            "responses") 
                grep $GREP_OPTS -A10 "Output/Response:" "$file" | grep $GREP_OPTS "$pattern"
                ;;
            "files")
                grep $GREP_OPTS "Modified:\|Created:" "$file" | grep $GREP_OPTS "$pattern"
                ;;
            "all"|*)
                grep $GREP_OPTS "$pattern" "$file"
                ;;
        esac
        
        # Check if we should continue based on limit
        if [[ -n "$LIMIT" ]]; then
            ((count++))
            if [[ $count -ge $LIMIT ]]; then
                echo -e "\n\033[1;33m... (showing first $LIMIT sessions, use --all for complete results)\033[0m"
                break
            fi
        fi
    done
}

# Perform the search
if [[ "$USE_INDEX" == "true" ]]; then
    echo "Using indexed search for: '$SEARCH_TERM'"
    echo "Search type: $SEARCH_TYPE"
    echo "========================"
    
    # Build index if it doesn't exist
    if [[ ! -f "$ADMIN_DIR/search-index.db" ]]; then
        echo "Building search index (first time setup)..."
        python3 "$ADMIN_DIR/search-index.py" build
    fi
    
    # Convert search type for index
    INDEX_TYPE=""
    case "$SEARCH_TYPE" in
        "prompts") INDEX_TYPE="prompt" ;;
        "responses") INDEX_TYPE="response" ;;  
        "files") INDEX_TYPE="file_change" ;;
    esac
    
    # Execute indexed search
    SEARCH_ARGS="search --query '$SEARCH_TERM'"
    [[ -n "$INDEX_TYPE" ]] && SEARCH_ARGS="$SEARCH_ARGS --type $INDEX_TYPE"
    [[ -n "$LIMIT" ]] && SEARCH_ARGS="$SEARCH_ARGS --limit $LIMIT"
    
    eval "python3 '$ADMIN_DIR/search-index.py' $SEARCH_ARGS"
else
    echo "Searching for: '$SEARCH_TERM'"
    echo "Search type: $SEARCH_TYPE"
    [[ -n "$DATE_FILTER" ]] && echo "Date filter: $DATE_FILTER"
    echo "========================"

    perform_search "$SESSION_FILES" "$SEARCH_TERM" "$SEARCH_TYPE"
fi

echo -e "\n\033[1;32mSearch complete.\033[0m"